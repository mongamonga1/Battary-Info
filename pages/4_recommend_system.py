# -*- coding: utf-8 -*-
"""Recommend system

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1rwlcjXB34w4umUnDQT2wc-3Y1NMXgSlZ
"""

import pandas as pd
from sklearn.metrics.pairwise import cosine_similarity

# ------------------------------------------------------------------
# 1) ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
# ------------------------------------------------------------------
TX_PATH = "data/í†µí•©ê±°ë˜ë‚´ì—­.csv"
MARKET_PATH = "data/ë§¤ë¬¼ë¦¬ìŠ¤íŠ¸.csv"
EVAL_PATH = "data/ì—…ì²´í‰ê°€ì •ë³´.csv"

transactions = pd.read_csv(TX_PATH)
market = pd.read_csv(MARKET_PATH)
eval_df = pd.read_csv(EVAL_PATH)

# ------------------------------------------------------------------
# 2) ëŒ€ìƒ ê¸°ì—… ì„¤ì •
# ------------------------------------------------------------------
target = "ì„±ì¼í•˜ì´í…(ì£¼)"

# ------------------------------------------------------------------
# 3) íŒë§¤ì + êµ¬ë§¤ì ê±°ë˜ë‚´ì—­ í†µí•©
# ------------------------------------------------------------------
all_tx = pd.concat([
    transactions[["íŒë§¤ì—…ì²´", "ì œí’ˆêµ¬ë¶„"]].rename(columns={"íŒë§¤ì—…ì²´": "ì—…ì²´ëª…"}),
    transactions[["êµ¬ë§¤ì—…ì²´", "ì œí’ˆêµ¬ë¶„"]].rename(columns={"êµ¬ë§¤ì—…ì²´": "ì—…ì²´ëª…"})
])

# ------------------------------------------------------------------
# 4) ê¸°ì—… Ã— ì œí’ˆêµ¬ë¶„ ë§¤íŠ¸ë¦­ìŠ¤ ìƒì„±
# ------------------------------------------------------------------
cust_product_matrix = all_tx.pivot_table(index="ì—…ì²´ëª…", columns="ì œí’ˆêµ¬ë¶„", aggfunc=len, fill_value=0)

# ------------------------------------------------------------------
# 5) ìœ ì‚¬ê¸°ì—… Top-5 ì„ ì • (Cosine Similarity)
# ------------------------------------------------------------------
cos_sim = cosine_similarity(cust_product_matrix)
cos_sim_df = pd.DataFrame(cos_sim, index=cust_product_matrix.index, columns=cust_product_matrix.index)

similar_customers = (
    cos_sim_df[target]
    .sort_values(ascending=False)
    .drop(index=target)
    .head(5)
)

# ------------------------------------------------------------------
# 6) ì¶”ì²œ ì ìˆ˜ í•©ì‚°
#sim_score: ìœ ì‚¬ ê¸°ì—…ë“¤ì´ ë§ì´ ê±°ë˜í•œ ì œí’ˆì¼ìˆ˜ë¡ ì ìˆ˜ ë†’ìŒ
#my_score: ë‚´ê°€ ìì£¼ ê±°ë˜í•œ ì œí’ˆì¼ìˆ˜ë¡ ì ìˆ˜ ë†’ìŒ
# ë‘ ì ìˆ˜ë¥¼ ê°€ì¤‘ í‰ê· ìœ¼ë¡œ ê²°í•© (ì˜ˆ: 0.5 * sim_score + 0.5 * my_score)
# ì„±ì¼í•˜ì´í…(ì£¼)ì˜ ê°œì¸ì  ê±°ë˜ ì„±í–¥ (ì½˜í…ì¸  ê¸°ë°˜ í•„í„°ë§)ê³¼ ìœ ì‚¬ ê¸°ì—…ë“¤ì´ ë§ì´ ê±°ë˜í•œ ì œí’ˆêµ¬ë¶„ ê¸°ë°˜ ë§¤ë¬¼(í˜‘ì—… ê¸°ë°˜ í•„í„°ë§)ë¥¼ ë™ì‹œì— ë°˜ì˜í•œ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸
# ------------------------------------------------------------------
# 6-1) ìœ ì‚¬ê¸°ì—…ë“¤ì´ ë§ì´ ê±°ë˜í•œ ì œí’ˆêµ¬ë¶„ ì ìˆ˜
similar_tx = all_tx[all_tx["ì—…ì²´ëª…"].isin(similar_customers.index)]
sim_counts = similar_tx["ì œí’ˆêµ¬ë¶„"].value_counts(normalize=True).to_dict()

# 6-2) ë‚´ê°€ ìì£¼ ê±°ë˜í•œ ì œí’ˆêµ¬ë¶„ ì ìˆ˜
my_tx = all_tx[all_tx["ì—…ì²´ëª…"] == target]
my_counts = my_tx["ì œí’ˆêµ¬ë¶„"].value_counts(normalize=True).to_dict()

# 6-3) ì œí’ˆêµ¬ë¶„ë³„ í•˜ì´ë¸Œë¦¬ë“œ ì ìˆ˜ ê³„ì‚°
product_scores = {}
for item in set(sim_counts.keys()).union(my_counts.keys()):
    sim_score = sim_counts.get(item, 0)
    my_score = my_counts.get(item, 0)
    hybrid_score = 0.5 * sim_score + 0.5 * my_score  # ê°€ì¤‘ì¹˜ëŠ” ìƒí™©ì— ë”°ë¼ ì¡°ì • ê°€ëŠ¥
    product_scores[item] = hybrid_score

# 6-4) ìƒìœ„ ì œí’ˆêµ¬ë¶„ ì„ íƒ
top_items = sorted(product_scores, key=product_scores.get, reverse=True)


# ------------------------------------------------------------------
# 7) ë§¤ë¬¼ í•„í„°ë§ ë° ì¶”ê°€ ì •ë³´ ë¶€ì—¬
# ------------------------------------------------------------------
filtered_market = market[market["ì œí’ˆêµ¬ë¶„"].isin(top_items)].copy()

# ì„±ì¼í•˜ì´í… ê³¼ê±° ê±°ë˜ ì—…ì²´
tx_cust = transactions.query("íŒë§¤ì—…ì²´ == @target or êµ¬ë§¤ì—…ì²´ == @target")
prev_partners = set(tx_cust["íŒë§¤ì—…ì²´"]).union(set(tx_cust["êµ¬ë§¤ì—…ì²´"])) - {target}
filtered_market["ì´ì „ê±°ë˜ì—…ì²´ì—¬ë¶€"] = filtered_market["íŒë§¤ì—…ì²´"].isin(prev_partners)

# ì œí’ˆêµ¬ë¶„ ìš°ì„ ìˆœìœ„
filtered_market["ì œí’ˆêµ¬ë¶„_ìš°ì„ ìˆœìœ„"] = filtered_market["ì œí’ˆêµ¬ë¶„"].apply(
    lambda x: top_items.index(x) if x in top_items else len(top_items)
)

# ì´í‰ê°€ì ìˆ˜ ë³‘í•©
filtered_market = filtered_market.merge(
    eval_df[["ì—…ì²´ëª…", "ì´í‰ê°€ì ìˆ˜"]],
    left_on="íŒë§¤ì—…ì²´", right_on="ì—…ì²´ëª…", how="left"
)

# ------------------------------------------------------------------
# 8) ì •ë ¬: ì œí’ˆêµ¬ë¶„ ìš°ì„  â†’ ì´ì „ ê±°ë˜ì—…ì²´ ìš°ì„  â†’ ì´í‰ê°€ì ìˆ˜ ë†’ì€ ìˆœ
# ------------------------------------------------------------------
filtered_market = filtered_market.sort_values(
    by=["ì œí’ˆêµ¬ë¶„_ìš°ì„ ìˆœìœ„", "ì´ì „ê±°ë˜ì—…ì²´ì—¬ë¶€", "ì´í‰ê°€ì ìˆ˜"],
    ascending=[True, False, False]
)

# ------------------------------------------------------------------
# 9) ê²°ê³¼ ì¶œë ¥: ì„±ì¼í•˜ì´í…(ì£¼)ë¥¼ ìœ„í•œ ì¶”ì²œ ë§¤ë¬¼ Top 10
# ------------------------------------------------------------------
# ì„ íƒ ì»¬ëŸ¼
columns = ["íŒë§¤ì—…ì²´", "ì œí’ˆêµ¬ë¶„", "ë°°í„°ë¦¬ì¢…ë¥˜", "ê³„ì•½ìˆ˜ëŸ‰(ë‹¨ìœ„ë‹¹)", "ì´í‰ê°€ì ìˆ˜"]
result = filtered_market.head(10)[columns].reset_index(drop=True)

# í‘œ í˜•íƒœ ì¶œë ¥
print("\nğŸ“Š ì„±ì¼í•˜ì´í…(ì£¼)ë¥¼ ìœ„í•œ ì¶”ì²œ ë§¤ë¬¼ Top 10 (í‘œ í˜•ì‹)\n")
print(result.to_markdown(index=False))
